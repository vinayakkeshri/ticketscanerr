<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>White Penguin ‚Äî Event Check-In</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;          /* deep navy */
      --panel:#0f1724;       /* dark card */
      --glass: rgba(255,255,255,0.04);
      --muted:#9aa4b2;
      --accent1: #7c3aed;    /* violet */
      --accent2: #06b6d4;    /* cyan */
      --success:#16a34a;
      --danger:#ef4444;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(180deg,var(--bg) 0%, #071024 100%);
      color:#e6eef2;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* top bar */
    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:14px 18px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      position:sticky; top:0; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      z-index:40;
    }
    .hamb{width:46px;height:46px;border-radius:12px;background:var(--panel);display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .hamb .bar{width:20px;height:2px;background:var(--muted);margin:3px 0;border-radius:2px}
    .brand{font-weight:700;color:linear-gradient(90deg,var(--accent1),var(--accent2));font-size:1rem}
    .title{margin-left:8px;font-weight:700;color:var(--accent2);font-size:1.05rem}
    .top-actions{margin-left:auto;display:flex;gap:10px;align-items:center}

    /* layout */
    .main{display:grid;grid-template-columns: 1fr 380px;gap:18px;padding:18px;align-items:start}
    @media (max-width:1000px){ .main{grid-template-columns:1fr;} .sidebar{position:static;width:auto} }

    /* left panel */
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:18px;box-shadow: 0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.02)}
    .video-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
    video{width:100%;max-width:720px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:#000}
    #status{color:var(--muted);font-size:0.95rem}

    /* result card */
    .result{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);border:1px solid rgba(255,255,255,0.02)}
    .result h3{margin:0 0 8px 0}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:0.95rem}

    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021220}
    .btn-success{background:var(--success);color:#05220f}
    .btn-warning{background:#f59e0b;color:#2b1600}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .small{padding:7px 10px;font-size:0.95rem}

    /* manual input */
    .manual{display:flex;gap:8px;margin-top:12px}
    .manual input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}

    /* scan button */
    #scanAgainBtn{display:none;margin-top:12px;padding:10px 14px;border-radius:10px;border:none;background:var(--accent2);color:#001e22;cursor:pointer}

    /* right sidebar */
    .sidebar{width:360px;position:sticky;top:88px}
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .statcard{padding:14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
    .statcard .num{font-size:1.6rem;font-weight:700;color:var(--accent1)}
    .guest-list{margin-top:12px;max-height:58vh;overflow:auto;padding-right:6px}

    .guest{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.01)}
    .guest .name{font-weight:600}
    .guest .meta{color:var(--muted);font-size:0.9rem}

    /* subtle animations */
    .pulse{animation:pulse .7s ease-out 1}
    @keyframes pulse{0%{transform:scale(.99)}50%{transform:scale(1.03)}100%{transform:scale(1)}}

    /* tiny helpers */
    .muted-small{color:var(--muted);font-size:0.9rem}
  </style>
</head>
<body>
  <div class="topbar">
    <button id="hamb" class="hamb" title="Menu">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </button>
    <div style="display:flex;flex-direction:column">
      <div class="title">White Penguin ‚Äî Check-In</div>
      <div class="muted-small">Fast QR scanning ¬∑ Clean UI</div>
    </div>
    <div class="top-actions">
      <div class="muted" style="margin-right:10px">Live: <span id="status">starting camera...</span></div>
      <button id="refreshStatsTop" class="btn btn-ghost small">Refresh stats</button>
    </div>
  </div>

  <div class="main">
    <!-- left -->
    <div>
      <div class="panel">
        <div class="video-wrap">
          <video id="video" autoplay playsinline muted></video>
          <div id="resultCard" class="result" style="display:none">
            <h3 id="resultTitle">‚Äî</h3>
            <div class="row"><strong>Ticket:</strong><div id="rcTicket" style="margin-left:8px"></div></div>
            <div class="row"><strong>Name:</strong><div id="rcName" style="margin-left:8px"></div></div>
            <div class="row" id="rcCheckinRow" style="display:none"><strong>Checked in:</strong><div id="rcCheckin" style="margin-left:8px"></div></div>
            <div class="row"><div id="rcHint" class="muted" style="margin-top:8px"></div></div>

            <div class="actions" id="cardActions" style="display:none">
              <button id="confirmBtn" class="btn btn-success">‚úÖ Confirm Check-In</button>
              <button id="holdBtn" class="btn btn-warning">‚è∏Ô∏è Hold</button>
              <button id="closeBtn" class="btn btn-ghost">Close</button>
            </div>
          </div>

          <div style="width:100%;display:flex;gap:8px;align-items:center;margin-top:12px">
            <div style="flex:1">
              <div class="manual">
                <input id="manualInput" placeholder="Type or paste ticket id" />
                <button id="manualLookup" class="btn btn-primary">Lookup</button>
              </div>
            </div>
          </div>

          <button id="scanAgainBtn">Scan Next Ticket</button>
        </div>
      </div>
    </div>

    <!-- right -->
    <aside class="sidebar">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Event Summary</strong><div class="muted-small">Quick overview & guest list</div></div>
          <button id="openList" class="btn btn-ghost small">Open</button>
        </div>

        <div style="margin-top:12px" class="stats">
          <div class="statcard"><div class="muted">Total</div><div class="num" id="statTotal">‚Äî</div></div>
          <div class="statcard"><div class="muted">Checked In</div><div class="num" id="statChecked">‚Äî</div></div>
        </div>

        <div style="margin-top:12px" class="statcard"><div class="muted">Remaining</div><div class="num" id="statRemaining">‚Äî</div></div>

        <div style="margin-top:12px"><input id="filterInput" placeholder="Filter by name or ticket" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit" /></div>

        <div class="guest-list" id="guestList" style="margin-top:12px">Loading...</div>
      </div>
    </aside>
  </div>

  <!-- jsQR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <script>
    // ========== SETTINGS ==========
    const DEBUG = true;
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxvU5rVyxh4TqSATUBDcEfhIyoDODFCEmb8iQwYGj7CsqoLcWhf1BSfbIJuk691a8jQSA/exec";
    // ------------------------------

    // DOM
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const resultCard = document.getElementById('resultCard');
    const resultTitle = document.getElementById('resultTitle');
    const rcTicket = document.getElementById('rcTicket');
    const rcName = document.getElementById('rcName');
    const rcCheckinRow = document.getElementById('rcCheckinRow');
    const rcCheckin = document.getElementById('rcCheckin');
    const rcHint = document.getElementById('rcHint');
    const cardActions = document.getElementById('cardActions');
    const confirmBtn = document.getElementById('confirmBtn');
    const holdBtn = document.getElementById('holdBtn');
    const closeBtn = document.getElementById('closeBtn');
    const scanAgainBtn = document.getElementById('scanAgainBtn');
    const manualInput = document.getElementById('manualInput');
    const manualLookup = document.getElementById('manualLookup');

    const statTotal = document.getElementById('statTotal');
    const statChecked = document.getElementById('statChecked');
    const statRemaining = document.getElementById('statRemaining');
    const guestList = document.getElementById('guestList');
    const filterInput = document.getElementById('filterInput');
    const refreshStatsTop = document.getElementById('refreshStatsTop');

    // state
    let scanning = false;
    let mediaStream = null;
    let lastScannedRaw = "";
    let awaitingConfirmation = false;
    let lastLoadedRows = [];

    function log(...a){ if(DEBUG) console.log(...a); }

    // beep
    function beepShort() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        g.gain.value = 0.08;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
      } catch(e){}
    }

    // UI helpers
    function showMessageCard(title, ticketId, name, opts = {}) {
      const { allowActions = true, isChecked = false, wasAlreadyChecked = false, checkinValue = "", hint = "" } = opts;
      resultCard.style.display = 'block';
      resultTitle.textContent = title || "";
      rcTicket.textContent = ticketId || "";
      rcName.textContent = name || "(no name)";
      rcCheckinRow.style.display = (isChecked || wasAlreadyChecked) ? "flex" : "none";
      rcCheckin.textContent = checkinValue || "";
      rcHint.textContent = hint || "";
      if (allowActions && !wasAlreadyChecked && !isChecked) {
        cardActions.style.display = 'flex';
      } else {
        cardActions.style.display = 'none';
      }
    }
    function hideCard(){ resultCard.style.display = 'none'; cardActions.style.display='none'; awaitingConfirmation=false; }

    // camera control
    function stopScannerAndStream() {
      scanning = false;
      try {
        if (mediaStream) {
          mediaStream.getTracks().forEach(t => t.stop());
          mediaStream = null;
        }
      } catch(e){ log('stop stream', e); }
    }

    async function startCameraAndScan() {
      try {
        statusEl.textContent = 'Requesting camera...';
        stopScannerAndStream();
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        video.srcObject = mediaStream;
        video.setAttribute('playsinline', true);
        await video.play();
        statusEl.textContent = 'Camera started ‚Äî scanning...';
        lastScannedRaw = "";
        awaitingConfirmation = false;
        startScannerLoop();
      } catch (err) {
        console.error('camera error', err);
        statusEl.textContent = 'Camera error: ' + (err.message || err);
        showMessageCard('‚ùå Camera Error', '', '', { allowActions:false, hint: 'Allow camera or try another browser.' });
        scanAgainBtn.style.display = 'block';
      }
    }

    function startScannerLoop() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      scanning = true;
      function frame() {
        if (!scanning) return;
        if (awaitingConfirmation) return requestAnimationFrame(frame);
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          try { ctx.drawImage(video, 0, 0, canvas.width, canvas.height); } catch { return requestAnimationFrame(frame); }
          let imageData;
          try { imageData = ctx.getImageData(0,0,canvas.width,canvas.height); } catch { return requestAnimationFrame(frame); }
          let code;
          try { code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" }); } catch {}
          if (code && code.data) {
            const raw = String(code.data || "");
            if (raw === lastScannedRaw) return requestAnimationFrame(frame);
            lastScannedRaw = raw;
            beepShort();
            try { navigator.vibrate && navigator.vibrate(100); } catch {}
            awaitingConfirmation = true;
            statusEl.textContent = 'QR detected ‚Äî looking up...';
            stopScannerAndStream();
            performLookup(raw).catch(err => {
              console.error('lookup err', err);
              showMessageCard('‚ùå Lookup Error', raw, '', { allowActions:false, hint: String(err) });
              scanAgainBtn.style.display = 'block';
              awaitingConfirmation = false;
            });
            return;
          }
        }
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    // network: lookup & checkin
    async function performLookup(rawScanned) {
      const raw = String(rawScanned || "");
      const ticketId = raw.replace(/\r?\n|\r/g, "").trim().toLowerCase();
      if (!ticketId) {
        showMessageCard('‚ùå Invalid QR', '', '', { allowActions:false, hint: 'Empty QR' });
        scanAgainBtn.style.display = 'block';
        awaitingConfirmation = false;
        return;
      }
      const url = `${WEB_APP_URL}?action=lookup&ticketId=${encodeURIComponent(ticketId)}`;
      let resp;
      try { resp = await fetch(url, { cache: "no-store" }); } catch (err) {
        showMessageCard('‚ùå Network Error', ticketId, '', { allowActions:false, hint: 'Network issue' });
        scanAgainBtn.style.display = 'block';
        awaitingConfirmation = false;
        return;
      }
      if (!resp.ok) {
        showMessageCard('‚ùå Server Error', ticketId, '', { allowActions:false, hint: `Server ${resp.status}` });
        scanAgainBtn.style.display = 'block';
        awaitingConfirmation = false;
        return;
      }
      let data;
      try { data = await resp.json(); } catch { showMessageCard('‚ùå Invalid Response', ticketId, '', { allowActions:false, hint: 'Bad JSON' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }
      if (!data.success) { showMessageCard('‚ùå Error', ticketId, '', { allowActions:false, hint: data.error || 'Unknown' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }
      if (!data.found) { showMessageCard('‚ùå Ticket Not Found', ticketId, '', { allowActions:false, hint: 'Ticket missing' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }

      const attendeeName = data.name || '(no name)';
      const alreadyCheckedIn = !!data.alreadyCheckedIn;
      const checkinValue = data.checkinValue || '';

      if (alreadyCheckedIn) {
        showMessageCard('‚ö†Ô∏è Already Checked In', ticketId, attendeeName, { allowActions:false, isChecked:true, wasAlreadyChecked:true, checkinValue, hint: 'Ticket already checked-in' });
        scanAgainBtn.style.display='block'; awaitingConfirmation=false; return;
      }

      showMessageCard('üîé Verify Attendee', ticketId, attendeeName, { allowActions:true, hint: 'If OK, press Confirm' });

      confirmBtn.onclick = async () => {
        confirmBtn.disabled = true; confirmBtn.textContent = 'Checking in...';
        try {
          const result = await performCheckin(ticketId);
          showMessageCard('‚úÖ Checked In', ticketId, result.name || attendeeName, { allowActions:false, isChecked:true, checkinValue: result.checkinValue || '', hint: 'Success' });
          resultCard.classList.add('pulse');
          try { navigator.vibrate && navigator.vibrate([60,40,60]); } catch {}
          await refreshStats();
        } catch (err) {
          showMessageCard('‚ùå Check-in Failed', ticketId, attendeeName, { allowActions:false, hint: String(err) });
        } finally {
          confirmBtn.disabled = false; confirmBtn.textContent = '‚úÖ Confirm Check-In';
          scanAgainBtn.style.display='block'; awaitingConfirmation=false;
        }
      };

      holdBtn.onclick = () => { hideCard(); scanAgainBtn.style.display='block'; statusEl.textContent = "Paused. Press Scan Next Ticket"; awaitingConfirmation=false; };
      closeBtn.onclick = () => { hideCard(); awaitingConfirmation=false; };
    }

    async function performCheckin(ticketId) {
      const url = `${WEB_APP_URL}?action=checkin&ticketId=${encodeURIComponent(ticketId)}`;
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`Server ${resp.status}`);
      const data = await resp.json().catch(()=>({}));
      if (!data.success) throw new Error(data.error || 'Unknown error');
      return data;
    }

    // manual lookup
    manualLookup.addEventListener('click', async ()=> {
      const v = (manualInput.value||'').trim();
      if (!v) return alert('Type a ticket id');
      statusEl.textContent = 'Manual lookup...';
      hideCard();
      await performLookup(v);
      statusEl.textContent = 'Manual lookup done';
    });

    scanAgainBtn.addEventListener('click', async ()=> {
      hideCard();
      scanAgainBtn.style.display='none';
      statusEl.textContent = 'Restarting camera...';
      await startCameraAndScan();
    });

    // stats: fetch and render
    async function refreshStats() {
      statTotal.textContent = '‚Äî'; statChecked.textContent = '‚Äî'; statRemaining.textContent = '‚Äî';
      guestList.innerHTML = 'Loading...';
      try {
        const resp = await fetch(`${WEB_APP_URL}?action=stats`, { cache: "no-store" });
        if (!resp.ok) throw new Error('Server ' + resp.status);
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown');
        statTotal.textContent = data.total ?? 0;
        statChecked.textContent = data.checked ?? 0;
        statRemaining.textContent = ( (data.total||0) - (data.checked||0) );
        lastLoadedRows = data.rows || [];
        renderGuestList(lastLoadedRows);
      } catch (err) {
        guestList.innerHTML = `<div class="muted">Unable to load: ${err.message||err}</div>`;
        log('stats error',err);
      }
    }

    function renderGuestList(rows) {
      if (!rows || !rows.length) { guestList.innerHTML = '<div class="muted">No guests</div>'; return; }
      const filter = (filterInput.value||'').toLowerCase().trim();
      guestList.innerHTML = '';
      rows.forEach(r => {
        if (filter) {
          const match = (r.name||'').toLowerCase().includes(filter) || (r.ticket||'').toLowerCase().includes(filter);
          if (!match) return;
        }
        const d = document.createElement('div'); d.className = 'guest';
        const left = document.createElement('div'); left.style.flex='1';
        const name = document.createElement('div'); name.className='name'; name.textContent = r.name || '(no name)';
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = (r.ticket || '') + (r.checked ? ` ‚Ä¢ ${r.checkedAt || 'checked'}` : ' ‚Ä¢ not checked');
        left.appendChild(name); left.appendChild(meta);
        const right = document.createElement('div');
        const call = document.createElement('button'); call.className='btn small';
        call.style.background='transparent'; call.style.border='1px solid rgba(255,255,255,0.04)'; call.style.color='var(--muted)';
        call.textContent = 'Call';
        if (!r.phone) { call.disabled = true; call.style.opacity = 0.5; call.title = 'No phone collected'; }
        else { call.onclick = ()=> window.location.href = `tel:${r.phone}`; }
        right.appendChild(call);
        d.appendChild(left); d.appendChild(right);
        guestList.appendChild(d);
      });
    }

    // filtering
    filterInput.addEventListener('input', ()=> renderGuestList(lastLoadedRows));

    // top refresh
    refreshStatsTop.addEventListener('click', refreshStats);

    // boot
    if (!("mediaDevices" in navigator) || !navigator.mediaDevices.getUserMedia) {
      statusEl.textContent = 'Camera not supported';
      showMessageCard('‚ùå Unsupported', '', '', { allowActions:false, hint: "Browser doesn't support camera." });
      scanAgainBtn.style.display='block';
    } else {
      setTimeout(()=> startCameraAndScan(), 120);
    }

    // don't auto-load stats until user refreshes - but load once after 1s
    setTimeout(() => refreshStats(), 800);
  </script>
</body>
</html>
