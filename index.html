<!DOCTYPE html>

<html>

<head>

  <meta charset="UTF-8">

  <title>QR Ticket Scanner</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>

    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; }

    #reader { width: 100%; max-width: 400px; margin: 20px auto; }

    #result { margin-top: 20px; padding: 10px; border-radius: 6px; }

    .ok { background: #e6ffed; border: 1px solid #49b869; }

    .bad { background: #ffe6e6; border: 1px solid #e04545; }

    button { padding: 6px 12px; margin-top: 8px; border-radius: 5px; cursor: pointer; }

  </style>

</head>

<body>

  <h2>QR Ticket Scanner</h2>

  <div id="reader"></div>

  <div id="status">Camera status: <span id="camState">idle</span></div>

  <div id="result"></div>



  <!-- QR scanning library -->

  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>



  <script>

    const resultDiv = document.getElementById('result');

    const camState = document.getElementById('camState');



    // ====== CONFIG: Paste your deployed Apps Script web app URL here ======

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyZtB0mDjtI5QUWemy3WGnkkYx43fI7LV4K7v-prDvWUoh477Ycpo6GtmnkThj3Vhmwzg/exec";



    function show(msg, ok) {

      resultDiv.innerHTML = msg;

      resultDiv.className = ok ? 'ok' : 'bad';

    }



    async function lookupTicket(ticketId) {

      try {

        const url = `${WEB_APP_URL}?action=lookup&ticketId=${encodeURIComponent(ticketId)}`;

        const res = await fetch(url);

        return await res.json();

      } catch (err) {

        return { success: false, error: err.toString() };

      }

    }



    async function checkInTicket(ticketId) {

      try {

        const url = `${WEB_APP_URL}?action=checkin&ticketId=${encodeURIComponent(ticketId)}`;

        const res = await fetch(url);

        return await res.json();

      } catch (err) {

        return { success: false, error: err.toString() };

      }

    }



    async function onScanSuccess(scannedText) {

      html5QrcodeScanner.clear().then(() => camState.textContent = 'stopped').catch(()=>{});

      const ticketId = scannedText.trim();

      const lookup = await lookupTicket(ticketId);



      if (!lookup.success) {

        show("Error: " + (lookup.error || "Unknown error"), false);

        setTimeout(startScanner, 2500);

        return;

      }



      if (!lookup.found) {

        show("Invalid ticket. ID not found: " + ticketId, false);

        setTimeout(startScanner, 2500);

        return;

      }



      if (lookup.checkedIn) {

        show(`<strong>Already Checked In</strong><br>Ticket ID: ${ticketId}<br>Checked at: ${lookup.checkinValue}`, false);

        setTimeout(startScanner, 2000);

        return;

      }



      // Show button to mark check-in

      resultDiv.innerHTML = `

        <div>

          <strong>Valid ticket</strong><br>

          Ticket ID: ${ticketId}<br>

          <button id="markBtn">Mark as Checked In</button>

          <button id="skipBtn">Skip / Cancel</button>

        </div>

      `;



      document.getElementById('markBtn').onclick = async () => {

        const ci = await checkInTicket(ticketId);

        if (ci.success && ci.found && !ci.alreadyCheckedIn) {

          show(`Checked in âœ…<br>Ticket: ${ticketId}<br>Time: ${ci.checkinValue}`, true);

        } else if (ci.success && ci.found && ci.alreadyCheckedIn) {

          show(`Already checked in earlier at ${ci.checkinValue}`, false);

        } else {

          show(`Error checking in: ${ci.error || "unknown"}`, false);

        }

        setTimeout(startScanner, 2000);

      };



      document.getElementById('skipBtn').onclick = () => startScanner();

    }



    function onScanFailure(error) {

      // optional: can log scan failures

    }



    let html5QrcodeScanner;

    function startScanner() {

      resultDiv.innerHTML = '';

      camState.textContent = 'starting...';

      if (html5QrcodeScanner && html5QrcodeScanner.clear) {

        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, onScanFailure)

          .then(() => camState.textContent = 'scanning')

          .catch(err => { show('Camera error: ' + err, false); camState.textContent = 'error'; });

      } else {

        html5QrcodeScanner = new Html5Qrcode("reader");

        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, onScanFailure)

          .then(() => camState.textContent = 'scanning')

          .catch(err => { show('Camera error: ' + err, false); camState.textContent = 'error'; });

      }

    }



    window.addEventListener('beforeunload', () => {

      if (html5QrcodeScanner && html5QrcodeScanner.clear) html5QrcodeScanner.clear().catch(()=>{});

    });



    // Initialize

    startScanner();

  </script>

</body>

</html>
