<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>White Penguin ‚Äî Check-In (Improved Sidebar)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #061223;
      --panel: #0b1520;
      --glass-bg: rgba(12,18,28,0.74);   /* slight glass */
      --glass-border: rgba(255,255,255,0.04);
      --muted: #9aa4b2;
      --accent1: #7c3aed;
      --accent2: #06b6d4;
      --success: #16a34a;
      --warning: #f59e0b;
      --radius: 14px;
      --card-shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6eef2;background:linear-gradient(180deg,var(--bg),#041021)}
    .topbar{
      display:flex;align-items:center;padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,0.02);position:sticky;top:0;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);z-index:120
    }
    .hamb{width:48px;height:48px;border-radius:12px;background:var(--panel);display:flex;flex-direction:column;justify-content:center;align-items:center;border:none;cursor:pointer;margin-right:12px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
    .hamb .bar{width:20px;height:2px;background:var(--muted);margin:3px 0;border-radius:2px}
    .brand{display:flex;flex-direction:column}
    .brand .title{font-weight:700; color:var(--accent2)}
    .brand .subtitle{font-size:12px;color:var(--muted)}
    .top-actions{margin-left:auto;display:flex;gap:10px;align-items:center}

    .container{display:grid;grid-template-columns:1fr 380px;gap:18px;padding:18px}
    @media (max-width:1000px){ .container{grid-template-columns:1fr;padding:12px} }

    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,0.02);box-shadow:var(--card-shadow)}
    .video-wrap{display:flex;flex-direction:column;gap:12px;align-items:center}
    video{width:100%;max-width:820px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:#000}
    #status{color:var(--muted);font-size:0.95rem}

    .result{width:100%;margin-top:8px;padding:12px;border-radius:10px;background:var(--panel);border:1px solid rgba(255,255,255,0.02)}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:0.95rem}

    .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021220}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn.success{background:var(--success);color:#04220f}
    .btn.warn{background:var(--warning);color:#301a00}
    .small{padding:8px 10px;font-size:0.95rem}
    .btn.disabled{opacity:0.45;cursor:not-allowed}

    .manual{display:flex;gap:8px}
    .manual input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}

    #scanAgainBtn{display:none;margin-top:8px;padding:10px 14px;border-radius:10px;border:none;background:var(--accent2);color:#021220;cursor:pointer}

    /* ---------- SIDEBAR (slides in from LEFT on desktop, full-screen drawer on mobile) ---------- */
    .sidebar-container{position:fixed;left:0;top:64px;bottom:0;width:420px;max-width:92vw;padding:18px;pointer-events:none;z-index:140}
    .sidebar{width:100%;height:100%;border-radius:14px;background:var(--glass-bg);backdrop-filter: blur(8px);border:1px solid var(--glass-border);box-shadow:var(--card-shadow);transform:translateX(-20px);opacity:0;transition:transform .32s ease,opacity .32s ease;pointer-events:auto}
    .sidebar.open{transform:translateX(0);opacity:1}
    @media (max-width:1000px){
      .sidebar-container{left:0;right:0;top:64px;padding:12px}
      .sidebar{width:100%;height:calc(100vh - 84px);border-radius:12px}
    }

    .sidebar .panel{background:transparent;border:none;padding:14px}

    .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .statcard{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
    .statcard .label{color:var(--muted);font-size:13px}
    .statcard .num{font-size:1.4rem;font-weight:800;color:var(--accent1);margin-top:6px}

    .list-controls{display:flex;gap:8px;margin-top:12px;align-items:center}
    .list-btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);cursor:pointer}
    .list-btn.active{background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.06));border:1px solid rgba(124,58,237,0.18);color:#e9defc}

    .filter{margin-top:12px}
    .filter input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}

    .guest-list{margin-top:12px;max-height:58vh;overflow:auto;padding-right:6px}
    .guest{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;margin-bottom:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
    .guest .left{flex:1}
    .guest .name{font-weight:700}
    .guest .meta{color:var(--muted);font-size:0.9rem;margin-top:6px}

    /* spinner small */
    .spinner{width:22px;height:22px;border-radius:50%;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--accent2);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .pulse{animation:pulse .7s ease-out 1}
    @keyframes pulse{0%{transform:scale(.99)}50%{transform:scale(1.03)}100%{transform:scale(1)}}

    /* responsive container when sidebar closed (so content covers whole) */
    .content-area{max-width:1100px;margin:0 auto}
  </style>
</head>
<body>
  <div class="topbar">
    <button id="hamb" class="hamb" aria-label="Open menu">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </button>

    <div class="brand">
      <div class="title">White Penguin ‚Äî Check-In</div>
      <div class="subtitle">Fast QR scanning ¬∑ Clean UX</div>
    </div>

    <div class="top-actions">
      <div id="status" class="muted">Starting camera...</div>
      <button id="refreshStatsTop" class="btn ghost small" title="Refresh summary">Refresh</button>
    </div>
  </div>

  <div class="container">
    <main class="content-area">
      <div class="panel">
        <div class="video-wrap">
          <video id="video" autoplay playsinline muted></video>

          <div id="resultCard" class="result" style="display:none">
            <h3 id="resultTitle">‚Äî</h3>
            <div class="row"><strong>Ticket:</strong><div id="rcTicket" style="margin-left:8px"></div></div>
            <div class="row"><strong>Name:</strong><div id="rcName" style="margin-left:8px"></div></div>
            <div class="row" id="rcCheckinRow" style="display:none"><strong>Checked in:</strong><div id="rcCheckin" style="margin-left:8px"></div></div>
            <div style="margin-top:8px" id="rcHint" class="muted"></div>

            <div class="actions" id="cardActions" style="display:none">
              <button id="confirmBtn" class="btn success">‚úÖ Confirm</button>
              <button id="holdBtn" class="btn warn">‚è∏ Hold</button>
              <button id="closeBtn" class="btn ghost">Close</button>
            </div>
          </div>

          <div style="width:100%;display:flex;gap:8px;align-items:center;margin-top:12px">
            <div style="flex:1">
              <div class="manual">
                <input id="manualInput" placeholder="Type or paste ticket id" aria-label="ticket id" />
                <button id="manualLookup" class="btn primary">Lookup</button>
              </div>
            </div>
          </div>

          <button id="scanAgainBtn">Scan Next Ticket</button>
        </div>
      </div>
    </main>

    <!-- Dummy right column to keep layout on desktop (sidebar slides in over it) -->
    <aside style="display:none;"></aside>
  </div>

  <!-- Sidebar container (slides from LEFT) -->
  <div class="sidebar-container" aria-hidden="true">
    <div id="sidebar" class="sidebar" role="dialog" aria-label="Event summary">
      <div class="panel" id="sidebarPanel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Event Summary</strong>
            <div class="muted" style="margin-top:4px;font-size:13px">Guest lists & quick actions</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="sidebarSpinner" style="display:none"><div class="spinner" /></div>
            <button id="closeSidebar" class="btn ghost small">Close</button>
          </div>
        </div>

        <div class="summary-grid">
          <div class="statcard">
            <div class="label">Total</div>
            <div class="num" id="statTotal">‚Äî</div>
          </div>
          <div class="statcard">
            <div class="label">Checked</div>
            <div class="num" id="statChecked">‚Äî</div>
          </div>
        </div>

        <div class="statcard" style="margin-top:12px">
          <div class="label">Remaining</div>
          <div class="num" id="statRemaining">‚Äî</div>
        </div>

        <div class="list-controls" style="margin-top:12px">
          <button id="btnAll" class="list-btn">All</button>
          <button id="btnChecked" class="list-btn">Checked</button>
          <button id="btnNot" class="list-btn">Not checked</button>
        </div>

        <div class="filter">
          <input id="filterInput" placeholder="Filter by name or ticket" />
        </div>

        <div class="guest-list" id="guestList">Open the menu to load guests</div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    /* ====== CONFIG ====== */
    const DEBUG = true;
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyPsGus1r56o49QeIbpx0fYnNZalZTdHlba1bCyyU8k26vBnOXmzXEbEWklWuhdWlrS/exec"; // <-- update me
    /* ==================== */

    // DOM
    const hamb = document.getElementById('hamb');
    const sidebarContainer = document.querySelector('.sidebar-container');
    const sidebar = document.getElementById('sidebar');
    const closeSidebar = document.getElementById('closeSidebar');
    const sidebarSpinner = document.getElementById('sidebarSpinner');
    const statusEl = document.getElementById('status');

    const video = document.getElementById('video');
    const resultCard = document.getElementById('resultCard');
    const resultTitle = document.getElementById('resultTitle');
    const rcTicket = document.getElementById('rcTicket');
    const rcName = document.getElementById('rcName');
    const rcCheckinRow = document.getElementById('rcCheckinRow');
    const rcCheckin = document.getElementById('rcCheckin');
    const rcHint = document.getElementById('rcHint');
    const cardActions = document.getElementById('cardActions');
    const confirmBtn = document.getElementById('confirmBtn');
    const holdBtn = document.getElementById('holdBtn');
    const closeBtn = document.getElementById('closeBtn');
    const scanAgainBtn = document.getElementById('scanAgainBtn');

    const manualInput = document.getElementById('manualInput');
    const manualLookup = document.getElementById('manualLookup');

    const statTotal = document.getElementById('statTotal');
    const statChecked = document.getElementById('statChecked');
    const statRemaining = document.getElementById('statRemaining');
    const btnAll = document.getElementById('btnAll');
    const btnChecked = document.getElementById('btnChecked');
    const btnNot = document.getElementById('btnNot');
    const filterInput = document.getElementById('filterInput');
    const guestList = document.getElementById('guestList');
    const refreshStatsTop = document.getElementById('refreshStatsTop');

    // state
    let mediaStream = null;
    let scanning = false;
    let lastScannedRaw = "";
    let awaitingConfirmation = false;
    let lastLoadedRows = [];
    let listMode = 'all';

    function log(...a){ if (DEBUG) console.log('[app]',...a); }

    /* ---------- CAMERA & SCANNER ---------- */
    async function startCameraAndScan(){
      try {
        statusEl.textContent = 'Requesting camera...';
        stopScannerAndStream();
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        video.srcObject = mediaStream;
        video.setAttribute('playsinline', true);
        await video.play();
        statusEl.textContent = 'Camera started ‚Äî scanning...';
        lastScannedRaw = "";
        awaitingConfirmation = false;
        startScannerLoop();
      } catch (err) {
        console.error('camera', err);
        statusEl.textContent = 'Camera error: ' + (err.message || err);
        showMessageCard('‚ùå Camera Error','','',{ allowActions:false, hint:'Allow camera or try another browser.'});
        scanAgainBtn.style.display = 'block';
      }
    }

    function stopScannerAndStream(){
      scanning = false;
      try { if (mediaStream) { mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; } } catch(e){ log('stop error', e); }
    }

    function startScannerLoop(){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      scanning = true;
      function frame(){
        if (!scanning) return;
        if (awaitingConfirmation) return requestAnimationFrame(frame);
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          try { ctx.drawImage(video, 0, 0, canvas.width, canvas.height); } catch { return requestAnimationFrame(frame); }
          let imageData;
          try { imageData = ctx.getImageData(0,0,canvas.width,canvas.height); } catch { return requestAnimationFrame(frame); }
          let code;
          try { code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" }); } catch {}
          if (code && code.data) {
            const raw = String(code.data || "");
            if (raw === lastScannedRaw) return requestAnimationFrame(frame);
            lastScannedRaw = raw;
            try { navigator.vibrate && navigator.vibrate(100); } catch {}
            beepShort();
            awaitingConfirmation = true;
            statusEl.textContent = 'QR detected ‚Äî looking up...';
            stopScannerAndStream();
            performLookup(raw).catch(err => {
              showMessageCard('‚ùå Lookup Error', raw, '', { allowActions:false, hint:String(err) });
              scanAgainBtn.style.display='block';
              awaitingConfirmation=false;
            });
            return;
          }
        }
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    function beepShort(){
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.type='sine'; o.frequency.value=880; g.gain.value=0.08;
        o.connect(g); g.connect(ctx.destination); o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
      } catch(e){}
    }

    /* ---------- UI CARD ---------- */
    function showMessageCard(title, ticketId, name, opts = {}){
      const { allowActions=true, isChecked=false, wasAlreadyChecked=false, checkinValue='', hint='' } = opts;
      resultCard.style.display = 'block';
      resultTitle.textContent = title || '';
      rcTicket.textContent = ticketId || '';
      rcName.textContent = name || '(no name)';
      rcCheckinRow.style.display = (isChecked || wasAlreadyChecked) ? 'flex' : 'none';
      rcCheckin.textContent = checkinValue || '';
      rcHint.textContent = hint || '';
      if (allowActions && !wasAlreadyChecked && !isChecked) cardActions.style.display = 'flex'; else cardActions.style.display = 'none';
    }
    function hideCard(){ resultCard.style.display = 'none'; cardActions.style.display='none'; awaitingConfirmation=false; }

    /* ---------- NETWORK: lookup, checkin, stats ---------- */
    async function performLookup(rawScanned){
      const raw = String(rawScanned || "");
      const ticketId = raw.replace(/\r?\n|\r/g, "").trim().toLowerCase();
      if (!ticketId) { showMessageCard('‚ùå Invalid QR','','',{allowActions:false, hint:'Empty QR'}); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }
      const url = `${WEB_APP_URL}?action=lookup&ticketId=${encodeURIComponent(ticketId)}`;
      let resp;
      try { resp = await fetch(url, { cache: "no-store" }); } catch (err) {
        showMessageCard('‚ùå Network Error', ticketId, '', { allowActions:false, hint:'Network issue' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return;
      }
      if (!resp.ok) { showMessageCard('‚ùå Server Error', ticketId, '', { allowActions:false, hint:`Server ${resp.status}` }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }
      let data;
      try { data = await resp.json(); } catch { showMessageCard('‚ùå Invalid Response', ticketId, '', { allowActions:false, hint:'Bad JSON' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }
      if (!data.success) { showMessageCard('‚ùå Error', ticketId, '', { allowActions:false, hint:data.error||'Unknown' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }
      if (!data.found) { showMessageCard('‚ùå Ticket Not Found', ticketId, '', { allowActions:false, hint:'Missing' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }

      const attendeeName = data.name || '(no name)';
      const alreadyCheckedIn = !!data.alreadyCheckedIn;
      const checkinValue = data.checkinValue || '';

      if (alreadyCheckedIn) {
        showMessageCard('‚ö†Ô∏è Already Checked In', ticketId, attendeeName, { allowActions:false, isChecked:true, wasAlreadyChecked:true, checkinValue, hint:'Ticket already checked-in' });
        scanAgainBtn.style.display='block'; awaitingConfirmation=false; return;
      }

      showMessageCard('üîé Verify Attendee', ticketId, attendeeName, { allowActions:true, hint:'If OK, press Confirm' });

      confirmBtn.onclick = async () => {
        confirmBtn.disabled = true; confirmBtn.textContent = 'Checking...';
        try {
          const result = await performCheckin(ticketId);
          showMessageCard('‚úÖ Checked In', ticketId, result.name || attendeeName, { allowActions:false, isChecked:true, checkinValue: result.checkinValue || '', hint:'Success' });
          resultCard.classList.add('pulse');
          try { navigator.vibrate && navigator.vibrate([60,40,60]); } catch {}
          await refreshStats(); // refresh counts and list
        } catch (err) {
          showMessageCard('‚ùå Check-in Failed', ticketId, attendeeName, { allowActions:false, hint:String(err) });
        } finally {
          confirmBtn.disabled = false; confirmBtn.textContent = '‚úÖ Confirm';
          scanAgainBtn.style.display='block'; awaitingConfirmation=false;
        }
      };

      holdBtn.onclick = () => { hideCard(); scanAgainBtn.style.display='block'; statusEl.textContent='Paused. Press Scan Next Ticket'; awaitingConfirmation=false; };
      closeBtn.onclick = () => { hideCard(); awaitingConfirmation=false; };
    }

    async function performCheckin(ticketId){
      const url = `${WEB_APP_URL}?action=checkin&ticketId=${encodeURIComponent(ticketId)}`;
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`Server ${resp.status}`);
      const data = await resp.json().catch(()=>({}));
      if (!data.success) throw new Error(data.error || 'Unknown error');
      return data;
    }

    /* ---------- manual lookup ---------- */
    manualLookup.addEventListener('click', async ()=>{
      const v = (manualInput.value || '').trim();
      if (!v) return alert('Type a ticket id');
      statusEl.textContent = 'Manual lookup...';
      hideCard();
      await performLookup(v);
      statusEl.textContent = 'Manual lookup done';
    });

    scanAgainBtn.addEventListener('click', async ()=>{
      hideCard();
      scanAgainBtn.style.display='none';
      statusEl.textContent = 'Restarting camera...';
      await startCameraAndScan();
    });

    /* ---------- STATS + GUEST LIST ---------- */
    async function refreshStats(){
      statTotal.textContent = '‚Äî'; statChecked.textContent = '‚Äî'; statRemaining.textContent = '‚Äî';
      guestList.innerHTML = '<div class="muted">Loading...</div>';
      sidebarSpinner.style.display = 'inline-block';
      try {
        const resp = await fetch(`${WEB_APP_URL}?action=stats`, { cache: "no-store" });
        if (!resp.ok) throw new Error('Server ' + resp.status);
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown');
        statTotal.textContent = data.total ?? 0;
        statChecked.textContent = data.checked ?? 0;
        statRemaining.textContent = ((data.total || 0) - (data.checked || 0));
        lastLoadedRows = (data.rows || []).map(r => ({ ...r, checked: !!r.checked }));
        // update buttons with counts
        btnAll.textContent = `All (${lastLoadedRows.length})`;
        btnChecked.textContent = `Checked (${lastLoadedRows.filter(r=>r.checked).length})`;
        btnNot.textContent = `Not checked (${lastLoadedRows.filter(r=>!r.checked).length})`;
        renderGuestList(lastLoadedRows);
      } catch (err) {
        guestList.innerHTML = `<div class="muted">Unable to load: ${err.message||err}</div>`;
        log('stats error', err);
      } finally {
        sidebarSpinner.style.display = 'none';
      }
    }

    function filterRows(rows, mode, filter){
      let out = rows;
      if (mode === 'checked') out = out.filter(r => !!r.checked);
      else if (mode === 'not') out = out.filter(r => !r.checked);
      if (!filter) return out;
      const f = filter.toLowerCase();
      return out.filter(r => (r.name||'').toLowerCase().includes(f) || (r.ticket||'').toLowerCase().includes(f));
    }

    function renderGuestList(rows){
      if (!rows || !rows.length) { guestList.innerHTML = '<div class="muted">No guests</div>'; return; }
      const filter = (filterInput.value || '').trim();
      const show = filterRows(rows, listMode, filter);
      if (show.length === 0) { guestList.innerHTML = '<div class="muted">No matching guests</div>'; return; }
      guestList.innerHTML = '';
      show.forEach(r=>{
        const div = document.createElement('div'); div.className = 'guest';
        const left = document.createElement('div'); left.className = 'left';
        const name = document.createElement('div'); name.className = 'name'; name.textContent = r.name || '(no name)';
        const meta = document.createElement('div'); meta.className = 'meta';
        meta.textContent = `${r.ticket || ''} ‚Ä¢ ${ r.checked ? (r.checkedAt || 'checked') : 'not checked' }`;
        left.appendChild(name); left.appendChild(meta);

        const right = document.createElement('div');
        const call = document.createElement('button'); call.className = 'btn ghost small';
        call.textContent = 'Call';
        if (!r.phone) { call.classList.add('disabled'); call.title = 'No phone collected'; } else call.onclick = ()=> window.location.href = `tel:${r.phone}`;
        right.appendChild(call);

        div.appendChild(left); div.appendChild(right);
        guestList.appendChild(div);
      });
    }

    // list buttons + filter events
    function setActiveListButtons(){
      [btnAll, btnChecked, btnNot].forEach(b => b.classList.remove('active'));
      if (listMode === 'all') btnAll.classList.add('active');
      if (listMode === 'checked') btnChecked.classList.add('active');
      if (listMode === 'not') btnNot.classList.add('active');
    }
    btnAll.addEventListener('click', ()=>{ listMode='all'; setActiveListButtons(); renderGuestList(lastLoadedRows); });
    btnChecked.addEventListener('click', ()=>{ listMode='checked'; setActiveListButtons(); renderGuestList(lastLoadedRows); });
    btnNot.addEventListener('click', ()=>{ listMode='not'; setActiveListButtons(); renderGuestList(lastLoadedRows); });
    filterInput.addEventListener('input', ()=> renderGuestList(lastLoadedRows));
    refreshStatsTop.addEventListener('click', ()=> refreshStats());

    // ---------- SIDEBAR OPEN/CLOSE (slide + fade) ----------
    async function openSidebar(){
      sidebarContainer.style.pointerEvents = 'auto';
      sidebar.classList.add('open');
      sidebarContainer.setAttribute('aria-hidden','false');
      setActiveListButtons();
      // load stats only when opening
      await refreshStats();
    }
    function closeSidebarFn(){
      sidebar.classList.remove('open');
      sidebarContainer.setAttribute('aria-hidden','true');
      // small delay to disable pointer-events after animation
      setTimeout(()=> { sidebarContainer.style.pointerEvents = 'none'; }, 340);
    }

    hamb.addEventListener('click', openSidebar);
    closeSidebar.addEventListener('click', closeSidebarFn);

    // close when clicking outside (desktop) ‚Äî detect clicks outside sidebar panel
    document.addEventListener('click', (e) => {
      if (!sidebar.contains(e.target) && !hamb.contains(e.target)) {
        if (sidebar.classList.contains('open')) closeSidebarFn();
      }
    });

    // ---------- INIT ----------
    if (!('mediaDevices' in navigator) || !navigator.mediaDevices.getUserMedia) {
      statusEl.textContent = "Camera not supported";
      showMessageCard('‚ùå Unsupported','','',{ allowActions:false, hint:"Your browser doesn't support camera." });
      scanAgainBtn.style.display = 'block';
    } else {
      setTimeout(()=> startCameraAndScan(), 120);
    }

    // small background stats refresh so counts appear quickly (guest list loads when sidebar opens)
    setTimeout(()=> refreshStats(), 800);
  </script>
</body>
</html>
