<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>White Penguin ‚Äî Event Check-In</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #061223;
      --panel: #0b1520;
      --muted: #9aa4b2;
      --accent1: #7c3aed;
      --accent2: #06b6d4;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.02);
      --radius: 14px;
      --card-border: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; -webkit-font-smoothing:antialiased;}
    body{
      background: linear-gradient(180deg,var(--bg) 0%, #041021 100%);
      color: #e6eef2;
    }

    /* Topbar */
    .topbar{display:flex;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.02);position:sticky;top:0;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);z-index:60}
    .hamb{width:46px;height:46px;border-radius:12px;background:var(--panel);display:flex;flex-direction:column;justify-content:center;align-items:center;border:none;cursor:pointer;margin-right:12px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
    .hamb .bar{width:20px;height:2px;background:var(--muted);margin:3px 0;border-radius:2px}
    .brand {display:flex;flex-direction:column}
    .brand .title {font-weight:700;color:var(--accent2);letter-spacing:0.2px}
    .brand .subtitle {font-size:12px;color:var(--muted)}
    .top-actions {margin-left:auto;display:flex;gap:10px;align-items:center}

    /* Layout */
    .container {display:grid;grid-template-columns: 1fr 360px;gap:18px;padding:18px;}
    @media (max-width:1000px){ .container{grid-template-columns:1fr;padding:12px} .sidebar{position:fixed;right:0;left:0;top:64px;height:calc(100% - 64px);background:transparent} }

    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:var(--radius);padding:16px;border:1px solid var(--card-border);box-shadow: 0 10px 30px rgba(0,0,0,0.6)}
    .video-wrap{display:flex;flex-direction:column;gap:12px;align-items:center}
    video{width:100%;max-width:820px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:#000}
    #status{color:var(--muted);font-size:0.95rem}

    /* result card */
    .result{width:100%;margin-top:6px;padding:12px;border-radius:10px;background:var(--panel);border:1px solid rgba(255,255,255,0.02)}
    .result h3{margin:0 0 6px 0}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:0.95rem}

    /* buttons */
    .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021220}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn.success{background:var(--success);color:#04220f}
    .btn.warn{background:var(--warning);color:#301a00}
    .small{padding:8px 10px;font-size:0.95rem}
    .btn.disabled{opacity:0.45;cursor:not-allowed}

    /* manual input */
    .manual{display:flex;gap:8px}
    .manual input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}

    /* Scan next */
    #scanAgainBtn{display:none;margin-top:8px;padding:10px 14px;border-radius:10px;border:none;background:var(--accent2);color:#021220;cursor:pointer}

    /* sidebar */
    .sidebar{width:360px;position:sticky;top:88px}
    .sidebar .panel{padding:14px}
    .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .statcard{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
    .statcard .label{color:var(--muted);font-size:13px}
    .statcard .num{font-size:1.4rem;font-weight:800;color:var(--accent1);margin-top:6px}

    /* list controls */
    .list-controls{display:flex;gap:8px;margin-top:12px;align-items:center}
    .filter{margin-top:12px}
    .filter input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}

    .guest-list{margin-top:12px;max-height:55vh;overflow:auto;padding-right:6px}
    .guest{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;margin-bottom:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
    .guest .left{flex:1}
    .guest .name{font-weight:700}
    .guest .meta{color:var(--muted);font-size:0.9rem;margin-top:6px}

    /* active for list buttons */
    .list-btn.active{background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.06));border:1px solid rgba(124,58,237,0.18);color:#e9defc}

    /* drawer for mobile */
    .drawer {position:fixed;top:64px;right:0;left:0;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.3));display:none;z-index:80;padding:12px}
    .drawer.open{display:block}
    .drawer .panel{height:100%;overflow:auto}

    .pulse{animation:pulse .7s ease-out 1}
    @keyframes pulse{0%{transform:scale(.99)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
  </style>
</head>
<body>
  <div class="topbar">
    <button id="hamb" class="hamb" aria-label="Open menu">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </button>

    <div class="brand">
      <div class="title">White Penguin ‚Äî Check-In</div>
      <div class="subtitle">Fast QR scanning ¬∑ Clean UI</div>
    </div>

    <div class="top-actions">
      <div id="status" class="muted">Starting camera...</div>
      <button id="refreshStatsTop" class="btn ghost small" title="Refresh summary">Refresh stats</button>
    </div>
  </div>

  <div class="container">
    <!-- LEFT: scanner / controls -->
    <main>
      <div class="panel">
        <div class="video-wrap">
          <video id="video" autoplay playsinline muted></video>
          <div id="resultCard" class="result" style="display:none">
            <h3 id="resultTitle">‚Äî</h3>
            <div class="row"><strong>Ticket:</strong><div id="rcTicket" style="margin-left:8px"></div></div>
            <div class="row"><strong>Name:</strong><div id="rcName" style="margin-left:8px"></div></div>
            <div class="row" id="rcCheckinRow" style="display:none"><strong>Checked in:</strong><div id="rcCheckin" style="margin-left:8px"></div></div>
            <div style="margin-top:8px" id="rcHint" class="muted"></div>

            <div class="actions" id="cardActions" style="display:none">
              <button id="confirmBtn" class="btn success">‚úÖ Confirm Check-In</button>
              <button id="holdBtn" class="btn warn">‚è∏Ô∏è Hold</button>
              <button id="closeBtn" class="btn ghost">Close</button>
            </div>
          </div>

          <div style="width:100%;display:flex;gap:8px;align-items:center;margin-top:12px">
            <div style="flex:1">
              <div class="manual">
                <input id="manualInput" placeholder="Type or paste ticket id" aria-label="ticket id" />
                <button id="manualLookup" class="btn primary">Lookup</button>
              </div>
            </div>
          </div>

          <button id="scanAgainBtn">Scan Next Ticket</button>
        </div>
      </div>
    </main>

    <!-- RIGHT: summary / guest list -->
    <aside class="sidebar">
      <div class="panel" id="sidebarPanel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Event Summary</strong>
            <div class="muted" style="margin-top:4px;font-size:13px">Open the menu (top-left) to view guest lists</div>
          </div>
          <button id="openList" class="btn ghost small">Open</button>
        </div>

        <div class="summary-grid">
          <div class="statcard">
            <div class="label">Total</div>
            <div class="num" id="statTotal">‚Äî</div>
          </div>
          <div class="statcard">
            <div class="label">Checked In</div>
            <div class="num" id="statChecked">‚Äî</div>
          </div>
        </div>

        <div class="statcard" style="margin-top:12px">
          <div class="label">Remaining</div>
          <div class="num" id="statRemaining">‚Äî</div>
        </div>

        <div style="margin-top:12px" class="list-controls">
          <button id="btnAll" class="btn ghost small list-btn">All</button>
          <button id="btnChecked" class="btn ghost small list-btn">Checked</button>
          <button id="btnNot" class="btn ghost small list-btn">Not checked</button>
        </div>

        <div class="filter">
          <input id="filterInput" placeholder="Filter by name or ticket" />
        </div>

        <div class="guest-list" id="guestList">Open the menu to load guests</div>
      </div>
    </aside>
  </div>

  <!-- mobile drawer (used on small screens) -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Guest List</strong><div class="muted" style="font-size:12px">Tap outside to close</div></div>
        <button id="closeDrawer" class="btn ghost small">Close</button>
      </div>

      <div style="margin-top:12px" class="list-controls">
        <button id="mobileBtnAll" class="btn ghost small list-btn">All</button>
        <button id="mobileBtnChecked" class="btn ghost small list-btn">Checked</button>
        <button id="mobileBtnNot" class="btn ghost small list-btn">Not checked</button>
      </div>

      <div style="margin-top:12px"><input id="mobileFilter" placeholder="Filter by name or ticket" /></div>
      <div class="guest-list" id="mobileGuestList" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- jsQR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <script>
    // ============ CONFIG ============
    const DEBUG = true;
    // <-- replace with your deployed Apps Script URL -->
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzKr2r9QItmXB-5lvxOvmP9itkHItpk7Ww03cVc9N0zAhQHH4zxrf9L9SJrPThgfOjYlw/exec";
    // ================================

    // DOM references
    const hamb = document.getElementById('hamb');
    const drawer = document.getElementById('drawer');
    const closeDrawer = document.getElementById('closeDrawer');
    const openListBtn = document.getElementById('openList');
    const statusEl = document.getElementById('status');
    const video = document.getElementById('video');

    const resultCard = document.getElementById('resultCard');
    const resultTitle = document.getElementById('resultTitle');
    const rcTicket = document.getElementById('rcTicket');
    const rcName = document.getElementById('rcName');
    const rcCheckinRow = document.getElementById('rcCheckinRow');
    const rcCheckin = document.getElementById('rcCheckin');
    const rcHint = document.getElementById('rcHint');
    const cardActions = document.getElementById('cardActions');
    const confirmBtn = document.getElementById('confirmBtn');
    const holdBtn = document.getElementById('holdBtn');
    const closeBtn = document.getElementById('closeBtn');
    const scanAgainBtn = document.getElementById('scanAgainBtn');

    const manualInput = document.getElementById('manualInput');
    const manualLookup = document.getElementById('manualLookup');

    // summary / list
    const statTotal = document.getElementById('statTotal');
    const statChecked = document.getElementById('statChecked');
    const statRemaining = document.getElementById('statRemaining');
    const btnAll = document.getElementById('btnAll');
    const btnChecked = document.getElementById('btnChecked');
    const btnNot = document.getElementById('btnNot');
    const filterInput = document.getElementById('filterInput');
    const guestList = document.getElementById('guestList');
    const refreshStatsTop = document.getElementById('refreshStatsTop');

    // mobile drawer controls
    const mobileBtnAll = document.getElementById('mobileBtnAll');
    const mobileBtnChecked = document.getElementById('mobileBtnChecked');
    const mobileBtnNot = document.getElementById('mobileBtnNot');
    const mobileFilter = document.getElementById('mobileFilter');
    const mobileGuestList = document.getElementById('mobileGuestList');

    // state
    let mediaStream = null;
    let scanning = false;
    let lastScannedRaw = "";
    let awaitingConfirmation = false;
    let lastLoadedRows = []; // rows returned by stats endpoint
    let listMode = "all"; // all | checked | not

    function log(...args){ if (DEBUG) console.log('[app]',...args); }

    // ----------------- camera & scanner -----------------
    async function startCameraAndScan(){
      try {
        statusEl.textContent = 'Requesting camera...';
        stopScannerAndStream();
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        video.srcObject = mediaStream;
        video.setAttribute('playsinline', true);
        await video.play();
        statusEl.textContent = 'Camera started ‚Äî scanning...';
        lastScannedRaw = "";
        awaitingConfirmation = false;
        startScannerLoop();
      } catch (err) {
        console.error('camera', err);
        statusEl.textContent = 'Camera error: ' + (err.message || err);
        showMessageCard('‚ùå Camera Error','','',{ allowActions:false, hint: 'Allow camera or try another browser.'});
        scanAgainBtn.style.display = 'block';
      }
    }

    function stopScannerAndStream(){
      scanning = false;
      try { if (mediaStream) { mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; } } catch(e){ log('stop error', e); }
    }

    function startScannerLoop(){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      scanning = true;

      function frame(){
        if (!scanning) return;
        if (awaitingConfirmation) return requestAnimationFrame(frame);
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          try { ctx.drawImage(video, 0, 0, canvas.width, canvas.height); } catch { return requestAnimationFrame(frame); }
          let imageData;
          try { imageData = ctx.getImageData(0,0,canvas.width,canvas.height); } catch { return requestAnimationFrame(frame); }
          let code;
          try { code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" }); } catch {}
          if (code && code.data) {
            const raw = String(code.data || "");
            if (raw === lastScannedRaw) return requestAnimationFrame(frame);
            lastScannedRaw = raw;
            try { navigator.vibrate && navigator.vibrate(100); } catch {}
            beepShort();
            awaitingConfirmation = true;
            statusEl.textContent = 'QR detected ‚Äî looking up...';
            stopScannerAndStream();
            performLookup(raw).catch(err => {
              showMessageCard('‚ùå Lookup Error', raw, '', { allowActions:false, hint: String(err) });
              scanAgainBtn.style.display = 'block';
              awaitingConfirmation = false;
            });
            return;
          }
        }
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    function beepShort(){
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.08;
        o.connect(g); g.connect(ctx.destination); o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
      } catch(e){}
    }

    // ----------------- UI card -----------------
    function showMessageCard(title, ticketId, name, opts = {}){
      const { allowActions=true, isChecked=false, wasAlreadyChecked=false, checkinValue='', hint='' } = opts;
      resultCard.style.display = 'block';
      resultTitle.textContent = title || '';
      rcTicket.textContent = ticketId || '';
      rcName.textContent = name || '(no name)';
      rcCheckinRow.style.display = (isChecked || wasAlreadyChecked) ? 'flex' : 'none';
      rcCheckin.textContent = checkinValue || '';
      rcHint.textContent = hint || '';
      if (allowActions && !wasAlreadyChecked && !isChecked) cardActions.style.display = 'flex'; else cardActions.style.display = 'none';
    }
    function hideCard(){ resultCard.style.display = 'none'; cardActions.style.display='none'; awaitingConfirmation=false; }

    // ----------------- network (lookup / checkin / stats) -----------------
    async function performLookup(rawScanned){
      const raw = String(rawScanned || "");
      const ticketId = raw.replace(/\r?\n|\r/g, "").trim().toLowerCase();
      if (!ticketId) {
        showMessageCard('‚ùå Invalid QR','','',{ allowActions:false, hint:'Empty QR' });
        scanAgainBtn.style.display='block'; awaitingConfirmation=false; return;
      }
      const url = `${WEB_APP_URL}?action=lookup&ticketId=${encodeURIComponent(ticketId)}`;
      let resp;
      try { resp = await fetch(url, { cache: "no-store" }); } catch (err) {
        showMessageCard('‚ùå Network Error', ticketId, '', { allowActions:false, hint:'Network issue' });
        scanAgainBtn.style.display='block'; awaitingConfirmation=false; return;
      }
      if (!resp.ok) {
        showMessageCard('‚ùå Server Error', ticketId, '', { allowActions:false, hint:`Server ${resp.status}` });
        scanAgainBtn.style.display='block'; awaitingConfirmation=false; return;
      }
      let data;
      try { data = await resp.json(); } catch { showMessageCard('‚ùå Invalid Response', ticketId, '', { allowActions:false, hint:'Bad JSON' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }
      if (!data.success) { showMessageCard('‚ùå Error', ticketId, '', { allowActions:false, hint: data.error || 'Unknown' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }
      if (!data.found) { showMessageCard('‚ùå Ticket Not Found', ticketId, '', { allowActions:false, hint:'Missing' }); scanAgainBtn.style.display='block'; awaitingConfirmation=false; return; }

      const attendeeName = data.name || '(no name)';
      const alreadyCheckedIn = !!data.alreadyCheckedIn;
      const checkinValue = data.checkinValue || '';

      if (alreadyCheckedIn) {
        showMessageCard('‚ö†Ô∏è Already Checked In', ticketId, attendeeName, { allowActions:false, isChecked:true, wasAlreadyChecked:true, checkinValue, hint:'Ticket already checked-in' });
        scanAgainBtn.style.display='block'; awaitingConfirmation=false; return;
      }

      showMessageCard('üîé Verify Attendee', ticketId, attendeeName, { allowActions:true, hint:'If OK, press Confirm' });

      confirmBtn.onclick = async () => {
        confirmBtn.disabled = true; confirmBtn.textContent = 'Checking in...';
        try {
          const result = await performCheckin(ticketId);
          showMessageCard('‚úÖ Checked In', ticketId, result.name || attendeeName, { allowActions:false, isChecked:true, checkinValue: result.checkinValue || '', hint:'Success' });
          resultCard.classList.add('pulse');
          try { navigator.vibrate && navigator.vibrate([60,40,60]); } catch {}
          await refreshStats(); // update counts & list
        } catch (err) {
          showMessageCard('‚ùå Check-in Failed', ticketId, attendeeName, { allowActions:false, hint: String(err) });
        } finally {
          confirmBtn.disabled = false; confirmBtn.textContent = '‚úÖ Confirm Check-In';
          scanAgainBtn.style.display='block'; awaitingConfirmation=false;
        }
      };

      holdBtn.onclick = () => { hideCard(); scanAgainBtn.style.display='block'; statusEl.textContent = "Paused. Press Scan Next Ticket"; awaitingConfirmation=false; };
      closeBtn.onclick = () => { hideCard(); awaitingConfirmation=false; };
    }

    async function performCheckin(ticketId){
      const url = `${WEB_APP_URL}?action=checkin&ticketId=${encodeURIComponent(ticketId)}`;
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`Server ${resp.status}`);
      const data = await resp.json().catch(()=>({}));
      if (!data.success) throw new Error(data.error || 'Unknown error');
      return data;
    }

    // ----------------- manual lookup -----------------
    manualLookup.addEventListener('click', async ()=>{
      const v = (manualInput.value || '').trim();
      if (!v) return alert('Type a ticket id');
      statusEl.textContent = 'Manual lookup...';
      hideCard();
      await performLookup(v);
      statusEl.textContent = 'Manual lookup done';
    });

    scanAgainBtn.addEventListener('click', async ()=>{
      hideCard();
      scanAgainBtn.style.display='none';
      statusEl.textContent = 'Restarting camera...';
      await startCameraAndScan();
    });

    // ----------------- stats & guest list -----------------
    async function refreshStats(){
      statTotal.textContent = '‚Äî'; statChecked.textContent = '‚Äî'; statRemaining.textContent = '‚Äî';
      guestList.innerHTML = '<div class="muted">Loading...</div>';
      mobileGuestList && (mobileGuestList.innerHTML = '<div class="muted">Loading...</div>');
      try {
        const resp = await fetch(`${WEB_APP_URL}?action=stats`, { cache: "no-store" });
        if (!resp.ok) throw new Error('Server ' + resp.status);
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown');
        statTotal.textContent = data.total ?? 0;
        statChecked.textContent = data.checked ?? 0;
        statRemaining.textContent = ((data.total || 0) - (data.checked || 0));
        lastLoadedRows = (data.rows || []).map(r => ({ ...r, checked: !!r.checked }));
        // update button labels with counts
        btnAll.textContent = `All (${lastLoadedRows.length})`;
        btnChecked.textContent = `Checked (${lastLoadedRows.filter(r=>r.checked).length})`;
        btnNot.textContent = `Not checked (${lastLoadedRows.filter(r=>!r.checked).length})`;
        mobileBtnAll.textContent = `All (${lastLoadedRows.length})`;
        mobileBtnChecked.textContent = `Checked (${lastLoadedRows.filter(r=>r.checked).length})`;
        mobileBtnNot.textContent = `Not checked (${lastLoadedRows.filter(r=>!r.checked).length})`;

        renderGuestList(lastLoadedRows);
        renderMobileGuestList(lastLoadedRows);
      } catch (err) {
        guestList.innerHTML = `<div class="muted">Unable to load: ${err.message||err}</div>`;
        mobileGuestList && (mobileGuestList.innerHTML = `<div class="muted">Unable to load: ${err.message||err}</div>`);
        log('stats error', err);
      }
    }

    function filterRows(rows, mode, filter){
      let out = rows;
      if (mode === 'checked') out = out.filter(r => !!r.checked);
      else if (mode === 'not') out = out.filter(r => !r.checked);
      if (!filter) return out;
      const f = filter.toLowerCase();
      return out.filter(r => (r.name||'').toLowerCase().includes(f) || (r.ticket||'').toLowerCase().includes(f));
    }

    function renderGuestList(rows){
      if (!rows || !rows.length) { guestList.innerHTML = '<div class="muted">No guests</div>'; return; }
      const filter = (filterInput.value || '').trim();
      const show = filterRows(rows, listMode, filter);
      if (show.length === 0) { guestList.innerHTML = '<div class="muted">No matching guests</div>'; return; }
      guestList.innerHTML = '';
      show.forEach(r=>{
        const div = document.createElement('div'); div.className = 'guest';
        const left = document.createElement('div'); left.className = 'left';
        const name = document.createElement('div'); name.className = 'name'; name.textContent = r.name || '(no name)';
        const meta = document.createElement('div'); meta.className = 'meta';
        meta.textContent = `${r.ticket || ''} ‚Ä¢ ${ r.checked ? (r.checkedAt || 'checked') : 'not checked' }`;
        left.appendChild(name); left.appendChild(meta);
        const right = document.createElement('div');
        const call = document.createElement('button'); call.className = 'btn ghost small';
        call.textContent = 'Call';
        if (!r.phone) { call.classList.add('disabled'); call.title = 'No phone collected'; } else call.onclick = ()=> window.location.href = `tel:${r.phone}`;
        right.appendChild(call);
        div.appendChild(left); div.appendChild(right);
        guestList.appendChild(div);
      });
    }

    function renderMobileGuestList(rows){
      if (!mobileGuestList) return;
      const filter = (mobileFilter.value || '').trim();
      const show = filterRows(rows, listMode, filter);
      if (!show.length) { mobileGuestList.innerHTML = '<div class="muted">No guests</div>'; return; }
      mobileGuestList.innerHTML = '';
      show.forEach(r=>{
        const div = document.createElement('div'); div.className = 'guest';
        const left = document.createElement('div'); left.className = 'left';
        const name = document.createElement('div'); name.className = 'name'; name.textContent = r.name || '(no name)';
        const meta = document.createElement('div'); meta.className = 'meta';
        meta.textContent = `${r.ticket || ''} ‚Ä¢ ${ r.checked ? (r.checkedAt || 'checked') : 'not checked' }`;
        left.appendChild(name); left.appendChild(meta);
        const right = document.createElement('div');
        const call = document.createElement('button'); call.className = 'btn ghost small';
        call.textContent = 'Call';
        if (!r.phone) { call.classList.add('disabled'); call.title = 'No phone collected'; } else call.onclick = ()=> window.location.href = `tel:${r.phone}`;
        right.appendChild(call);
        div.appendChild(left); div.appendChild(right);
        mobileGuestList.appendChild(div);
      });
    }

    // list buttons + filter events
    function setActiveListButtons(){
      [btnAll, btnChecked, btnNot].forEach(b => b.classList.remove('list-btn','active'));
      btnAll.classList.add('list-btn'); btnChecked.classList.add('list-btn'); btnNot.classList.add('list-btn');
      if (listMode === 'all') btnAll.classList.add('active');
      if (listMode === 'checked') btnChecked.classList.add('active');
      if (listMode === 'not') btnNot.classList.add('active');

      // mobile
      [mobileBtnAll, mobileBtnChecked, mobileBtnNot].forEach(b => b && b.classList.remove('active'));
      if (mobileBtnAll) mobileBtnAll.classList.add(listMode === 'all' ? 'active' : '');
      if (mobileBtnChecked) mobileBtnChecked.classList.add(listMode === 'checked' ? 'active' : '');
      if (mobileBtnNot) mobileBtnNot.classList.add(listMode === 'not' ? 'active' : '');
    }

    btnAll.addEventListener('click', ()=>{ listMode='all'; setActiveListButtons(); renderGuestList(lastLoadedRows); renderMobileGuestList(lastLoadedRows); });
    btnChecked.addEventListener('click', ()=>{ listMode='checked'; setActiveListButtons(); renderGuestList(lastLoadedRows); renderMobileGuestList(lastLoadedRows); });
    btnNot.addEventListener('click', ()=>{ listMode='not'; setActiveListButtons(); renderGuestList(lastLoadedRows); renderMobileGuestList(lastLoadedRows); });
    filterInput.addEventListener('input', ()=> renderGuestList(lastLoadedRows));
    mobileFilter && mobileFilter.addEventListener('input', ()=> renderMobileGuestList(lastLoadedRows));
    mobileBtnAll && mobileBtnAll.addEventListener('click', ()=>{ listMode='all'; setActiveListButtons(); renderMobileGuestList(lastLoadedRows); renderGuestList(lastLoadedRows); });
    mobileBtnChecked && mobileBtnChecked.addEventListener('click', ()=>{ listMode='checked'; setActiveListButtons(); renderMobileGuestList(lastLoadedRows); renderGuestList(lastLoadedRows); });
    mobileBtnNot && mobileBtnNot.addEventListener('click', ()=>{ listMode='not'; setActiveListButtons(); renderMobileGuestList(lastLoadedRows); renderGuestList(lastLoadedRows); });

    // open sidebar / drawer -> load stats on demand
    hamb.addEventListener('click', async ()=>{
      // open drawer on small screens, or focus sidebar on desktop
      if (window.innerWidth <= 1000) {
        drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
        await refreshStats();
      } else {
        // desktop: ensure sidebar visible; load stats
        await refreshStats();
        // scroll sidebar into view if needed
        document.getElementById('sidebarPanel').scrollIntoView({ behavior:'smooth' });
      }
      setActiveListButtons();
    });

    openListBtn.addEventListener('click', async ()=> {
      if (window.innerWidth <= 1000) {
        drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
      }
      await refreshStats();
      setActiveListButtons();
    });

    closeDrawer.addEventListener('click', ()=> { drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); });
    window.addEventListener('click', (e)=> { if (e.target === drawer) { drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); } });

    refreshStatsTop.addEventListener('click', ()=> refreshStats());

    // ----------------- init -----------------
    if (!('mediaDevices' in navigator) || !navigator.mediaDevices.getUserMedia) {
      statusEl.textContent = "Camera not supported";
      showMessageCard('‚ùå Unsupported', '', '', { allowActions:false, hint:"Your browser doesn't support camera." });
      scanAgainBtn.style.display = 'block';
    } else {
      setTimeout(()=> startCameraAndScan(), 120);
    }

    // load a first stats snapshot in background after small delay (but actual guest list loads when sidebar opens)
    setTimeout(()=> refreshStats(), 900);

  </script>
</body>
</html>
